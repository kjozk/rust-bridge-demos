# AGENTS.md

本リポジトリは、**Rust コアライブラリを複数言語・プラットフォームから安全かつ一貫して利用するためのデモ実装**を目的としています。
本ファイルでは、開発に関わる人間（および AI エージェント）が従うべき設計方針・実装指針・運用ルールを定義します。

---

## 1. 全体方針

* Rust を **Single Source of Truth（唯一の業務ロジック）** とする
* 各言語向けブリッジ層は **最小責務・薄いラッパー** に留める
* FFI / シリアライズ境界を **明確なアーキテクチャ境界** として扱う
* デモ用途であっても、**実運用を想定した設計品質**を維持する

---

## 2. アーキテクチャ責務分離

### Rust Core (`core/`)

* ドメインロジック・計算・検証処理をすべてここに集約
* 外部言語や UI フレームワークへの依存を **一切持たない**
* MessagePack / PyO3 などの技術詳細を直接参照しない

### ブリッジ層

#### PyO3 ブリッジ (`py-bridge/`)

* Python との ABI / API 変換責務のみを持つ
* Python 向けに自然な API を提供するが、ロジックは持たない

#### MessagePack ブリッジ (`messagepack-bridge/`)

* Rust 構造体と MessagePack バイト列の相互変換のみを担当
* 言語非依存のインターフェース境界として機能する

#### .NET ブリッジ (`dotnet-bridge/`)

* MessagePack を介した Rust との通信
* C# 側の DTO と Rust 側モデルの対応付け

### デモアプリ層

* Python / WPF それぞれで UI・UX の検証を行う
* ビジネスロジックは **一切実装しない**

---

## 3. SOLID 原則の適用方針

### S: Single Responsibility Principle

* 各クレート・各プロジェクトは **一つの役割のみ**を持つ
* 特にブリッジ層は「変換」以上の責務を持たせない

### O: Open / Closed Principle

* Rust Core の型やトレイトは拡張に開き、修正に閉じる
* 新しいフロントエンドや言語追加時に Core を改変しない

### L: Liskov Substitution Principle

* Rust 側のトレイト実装は意味論的に置換可能であること
* C# / Python 側の抽象も同様に振る舞い互換性を維持する

### I: Interface Segregation Principle

* 大きな万能インターフェースを作らない
* MessagePack 用・PyO3 用に **用途別の IF モデル**を定義する

### D: Dependency Inversion Principle

* 上位（UI・デモ）は下位（Rust Core）に依存しない
* 依存方向は常に **抽象 → 実装** となるよう設計する

---

## 4. モデル二重定義について

* Rust Core モデルとブリッジ用モデルが分かれることは**設計上許容**する

* これは以下の理由による

  * ABI / シリアライズ安定性の確保
  * 各言語における自然な型表現
  * Core の独立性維持

* 自動生成よりも **明示的な対応関係** を重視する

---

## 5. パフォーマンスとデータサイズ

* MessagePack は「コピー回数」「境界」を意識して設計する
* 数 MB〜数十 MB のデータ転送を現実的なユースケースとして想定
* 無意味な JSON 変換や中間表現の多重化を避ける

---

## 6. テスト方針

* Rust Core

  * 単体テスト・プロパティテストを優先
  * テストファーストを徹底する

* ブリッジ層

  * シリアライズ / デシリアライズの整合性テスト

* デモアプリ

  * スモークテスト・目視確認中心

---

## 7. コーディング・運用ルール

### コミット / PR 言語

* **Commit メッセージおよび Pull Request の記述は必ず日本語で行うこと**
* 理由：

  * 本リポジトリは設計意図の共有を重視するデモであるため
  * 設計判断・背景を日本語で正確に残すため

#### 例

* `core: Shape モデルと面積計算ロジックを追加`
* `dotnet-bridge: MessagePack DTO の責務分離`

### コードコメント

* Rust / C# / Python いずれも

  * **設計意図は日本語コメント可**
  * API 境界や unsafe / FFI 部分は必ず補足説明を入れる

---

## 8. AI エージェントへの注意事項

* 自動生成コードであっても、この AGENTS.md の方針に従うこと
* 勝手に責務を統合・簡略化しない
* 「デモだから雑でよい」という判断は禁止

---

以上を本リポジトリにおける共通ルールとします。
